@include moduk-exports("moduk/component/accordion") {
  $moduk-accordion-base-colour: moduk-colour("black");
  $moduk-accordion-hover-colour: moduk-colour("light-grey", $legacy: "grey-3");
  $moduk-accordion-icon-focus-colour: $moduk-focus-colour;
  $moduk-accordion-bottom-border-width: 1px;

  .moduk-accordion {
    @include moduk-responsive-margin(6, "bottom");
  }

  .moduk-accordion__section {
    padding-top: moduk-spacing(3);
  }

  .moduk-accordion__section-heading {
    // Override browser defaults to ensure consistent element height
    margin-top: 0;
    margin-bottom: 0;

    padding-top: moduk-spacing(3);
    padding-bottom: moduk-spacing(3);
  }

  .moduk-accordion__section-button {
    @include moduk-font($size: 24, $weight: bold);
    @include moduk-text-colour;

    display: block;
    margin-bottom: 0;
    padding-top: moduk-spacing(3);
  }

  // Remove the bottom margin from the last item inside the content
  .moduk-accordion__section-content > :last-child {
    margin-bottom: 0;
  }

  // JavaScript enabled
  .js-enabled {
    .moduk-accordion {
      // Border at the bottom of the whole accordion
      border-bottom: $moduk-accordion-bottom-border-width solid $moduk-border-colour;
    }

    .moduk-accordion__section {
      padding-top: 0;
    }

    // Hide the body of collapsed sections
    .moduk-accordion__section-content {
      display: none;
      @include moduk-responsive-padding(8, "bottom");
      @include moduk-responsive-padding(3, "top");
    }

    // Show the body of expanded sections
    .moduk-accordion__section--expanded .moduk-accordion__section-content {
      display: block;
    }

    .moduk-accordion__show-all {
      @include moduk-font($size: 19);
      position: relative;
      z-index: 1;

      margin-bottom: 9px;
      padding: moduk-spacing(1) 2px moduk-spacing(1) 0;

      border-width: 0;

      color: $moduk-link-colour;
      background: none;

      cursor: pointer;
      -webkit-appearance: none;

      @include moduk-media-query ($from: desktop) {
        margin-bottom: 14px;
      }

      // Remove default button focus outline in Firefox
      &::-moz-focus-inner {
        padding: 0;
        border: 0;
      }

      &:hover {
        color: $moduk-accordion-base-colour;
        background: $moduk-accordion-hover-colour;
        // The GOV.UK Design System focus state adds a box-shadow to the top and bottom of the
        // button. We add a grey box-shadow on hover too, to make the height of the hover state
        // match the height of the focus state.
        box-shadow: 0 -2px $moduk-accordion-hover-colour, 0 4px $moduk-accordion-hover-colour;

        .moduk-accordion__section-toggle-text {
          color: $moduk-accordion-base-colour;
        }

        .moduk-accordion-nav__chevron {
          color: $moduk-accordion-base-colour;
          background: $moduk-accordion-base-colour;
        }

        .moduk-accordion-nav__chevron:after {
          color: $moduk-accordion-hover-colour;
        }
      }

      &:focus {
        @include moduk-focused-text;

        .moduk-accordion-nav__chevron {
          background: $moduk-accordion-base-colour;
        }

        .moduk-accordion-nav__chevron:after {
          color: $moduk-accordion-icon-focus-colour;
        }
      }
    }

    .moduk-accordion__section-heading {
      padding: 0;
    }

    // Create Chevron icon aligned with text
    .moduk-accordion-nav__chevron {
      box-sizing: border-box;
      display: inline-block;

      position: relative;

      // Set size using rems to make the icon scale with text if user resizes text in their browser
      width: moduk-px-to-rem(20px);
      height: moduk-px-to-rem(20px);

      border: moduk-px-to-rem(1px) solid;
      border-radius: 50%;

      vertical-align: middle;

      // IE8 fallback of icon
      @include moduk-if-ie8 {
        display: inline-block;
        max-height: 20px;
        line-height: 1;
      }

      // Create inner chevron arrow
      &:after {
        content: "";
        box-sizing: border-box;
        display: block;

        position: absolute;
        bottom: moduk-px-to-rem(5px);
        left: moduk-px-to-rem(6px);

        width: moduk-px-to-rem(6px);
        height: moduk-px-to-rem(6px);

        transform: rotate(-45deg);

        border-top: moduk-px-to-rem(2px) solid;
        border-right: moduk-px-to-rem(2px) solid;

        // IE8 fallback of icon with HTML symbol
        @include moduk-if-ie8 {
          content: "\25B2"; // "▲"
          position: relative;
          border: 0;
        }
      }
    }

    // Rotate icon to create "Down" version
    .moduk-accordion-nav__chevron--down {
      transform: rotate(180deg);

      // IE8 fallback of arrow icon
      @include moduk-if-ie8 {
        &:after {
          content: "\25BC"; // "▼"
          transform: none;
        }
      }
    }

    .moduk-accordion__section-button {
      width: 100%;

      padding: moduk-spacing(2) 0 0 0;

      border: 0;

      border-top: $moduk-accordion-bottom-border-width solid $moduk-border-colour;

      // Visually separate the section from the one underneath when user changes colours in their
      // browser. See https://github.com/alphagov/moduk-frontend/issues/2321#issuecomment-924201488
      border-bottom: moduk-spacing(2) solid transparent;

      color: $moduk-text-colour;
      background: none;

      text-align: left;
      // Section headers have a pointer cursor as an additional affordance
      cursor: pointer;
      -webkit-appearance: none;

      @include moduk-media-query ($from: tablet) {
        padding-bottom: moduk-spacing(2);
      }

      &:active {
        color: $moduk-link-active-colour;
        background: none;
      }

      &:hover {
        color: $moduk-accordion-base-colour;
        background: $moduk-accordion-hover-colour;

        .moduk-accordion__section-toggle-text {
          color: $moduk-accordion-base-colour;
        }

        .moduk-accordion-nav__chevron {
          color: $moduk-accordion-base-colour;
          background: $moduk-accordion-base-colour;
        }

        .moduk-accordion-nav__chevron:after {
          color: $moduk-accordion-hover-colour;
        }
      }

      &:focus {
        // Remove default focus border around button as
        // styling is being applied to inner text elements that receive focus
        outline: 0;

        .moduk-accordion__section-heading-text-focus,
        .moduk-accordion__section-summary-focus,
        .moduk-accordion__section-toggle-focus {
          @include moduk-focused-text;
        }

        .moduk-accordion-nav__chevron {
          color: $moduk-accordion-base-colour;
          background: $moduk-accordion-base-colour;
        }

        .moduk-accordion-nav__chevron:after {
          color: $moduk-accordion-icon-focus-colour;
        }
      }

      // Remove default button focus outline in Firefox
      &::-moz-focus-inner {
        padding: 0;
        border: 0;
      }
    }

    // Remove the transparent border when the section is expanded to make it clear that the heading
    // relates to the content below. Adjust padding to maintain the height of the element.
    // See https://github.com/alphagov/moduk-frontend/pull/2257#issuecomment-951920798
    .moduk-accordion__section--expanded .moduk-accordion__section-button {
      padding-bottom: moduk-spacing(4);
      border-bottom: 0;
    }

    // As Chevron icon is vertically aligned it overlaps with the focus state bottom border
    // Styling adds some spacing
    .moduk-accordion__section-button:focus .moduk-accordion__section-toggle-focus {
      padding-bottom: 3px;

      @include moduk-media-query ($from: desktop) {
        padding-bottom: 2px;
      }
    }

    .moduk-accordion__section-toggle,
    .moduk-accordion__section-heading-text,
    .moduk-accordion__section-summary {
      display: block;
      margin-bottom: 13px;

      .moduk-accordion__section-heading-text-focus,
      .moduk-accordion__section-summary-focus,
      .moduk-accordion__section-toggle-focus {
        display: inline;
      }
    }

    // Add toggle link with Chevron icon on left.
    .moduk-accordion__section-toggle {
      @include moduk-typography-responsive($size: 19);
      @include moduk-typography-weight-regular;
      color: $moduk-link-colour;
    }

    // Add space between the icon and text.
    // Avoid applying spacing directly to the icon as the use of `transform` will change the
    // placement of any margins.
    .moduk-accordion__show-all-text,
    .moduk-accordion__section-toggle-text {
      margin-left: moduk-spacing(1);
      vertical-align: middle;
    }

    // Background colour adjustment when user changes colours in Firefox
    //
    // When user changes colours in Firefox, text colour inside <button> is always black
    // (regardless of the custom colours the user has set). This is fine when the text in the
    // button is not nested inside another element because when user changes colours in Firefox,
    // the immediate background colour of buttons is always white (again, regardless of user's
    // custom colours).
    //
    // However, when the text inside <button> is wrapped inside another element AND that element
    // sets a background colour, the text colour is still black but the background of that nested
    // element gets the user's custom background colour. When the custom background is a lighter
    // hue, the contrast might be sufficient. But if the user's custom background colour is a
    // darker colour, the contrast with the text might not be sufficient.
    //
    // To ensure sufficient contrast, override the background colour set by the focus state on the
    // nested elements to be transparent.
    //
    // Also override the background colour of the Show/Hide chevrons which set a background colour
    // on hover.
    @media screen and (forced-colors: active) {
      .moduk-accordion__show-all:hover,
      .moduk-accordion__section-button:hover {
        .moduk-accordion-nav__chevron {
          background-color: transparent;
        }
      }

      .moduk-accordion__show-all:focus,
      .moduk-accordion__section-button:focus {
        .moduk-accordion__section-heading-text-focus,
        .moduk-accordion__section-summary-focus,
        .moduk-accordion__section-toggle-focus,
        .moduk-accordion-nav__chevron {
          background: transparent;
          background-color: transparent;
        }
      }
    }

    // For devices that can't hover such as touch devices,
    // remove hover state as it can be stuck in that state (iOS).
    @media (hover: none) {
      .moduk-accordion__section-header:hover {
        border-top-color: $moduk-border-colour;

        box-shadow: inset 0 3px 0 0 $moduk-link-colour;

        .moduk-accordion__section-button {
          border-top-color: $moduk-border-colour;
        }
      }
    }
  }
}
